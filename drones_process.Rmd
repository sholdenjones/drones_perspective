---
title: "drones_process"
author: "Holden Jones"
date: "2026-02-04"
output: html_document
---

#1. Load packages, data

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(purrr)
library(ggplot2)

data <- read.csv("data/data_extraction.csv")
```

Only retain the columns required for figures and tables, rename columns
```{r}
cols_keep <- c("Study.ID", 
               "Country.of.study",
               "Country.of.first.author.s.affiliation",
               "Climatic.zone",
               "Ecosystem.Type",
               "UAV.Platform.Type",
               "Sensor.Type",
               "spatial_resolution_clean",
               "Spatial.extent",
               "Research.topic"
)

data <- data %>%
  select(all_of(cols_keep)) %>%
  rename(
    study_ID = Study.ID,
    country_study = Country.of.study,
    country_author = Country.of.first.author.s.affiliation,
    climate = Climatic.zone,
    ecosystem = Ecosystem.Type,
    platform = UAV.Platform.Type,
    sensor = Sensor.Type,
    spatial_resolution = spatial_resolution_clean,
    spatial_extent = Spatial.extent,
    topic = Research.topic
  )
```


#2. country_counts

```{r}
# Count studies by study location
study_country_counts <- data %>%
  separate_rows(country_study, sep = ",") %>%
  mutate(country = str_trim(country_study)) %>%
  distinct(study_ID, country) %>%
  count(country, name = "n_studies_in_country")

# Count studies by first author affiliation
author_country_counts <- data %>%
  separate_rows(country_author, sep = ",") %>%
  mutate(country = str_trim(country_author)) %>%
  distinct(study_ID, country) %>%
  count(country, name = "n_studies_by_author_country")

# Join into one table
country_counts <- full_join(
  study_country_counts,
  author_country_counts,
  by = "country"
) %>%
  replace_na(list(
    n_studies_in_country = 0,
    n_studies_by_author_country = 0
  )) %>%
  arrange(
    desc(n_studies_in_country),
    desc(n_studies_by_author_country)
  )

# write.csv(country_counts,
#           file = "output/country_counts.csv",
#           row.names = FALSE)
```


#3. ecosystem_counts

```{r}
ecosystem_counts <- data %>%
  separate_rows(ecosystem, sep = ",") %>%
  mutate(ecosystem = str_trim(ecosystem)) %>%
  distinct(study_ID, ecosystem) %>%
  count(ecosystem, name = "n_studies") %>%
  arrange(desc(n_studies))

# write.csv(ecosystem_counts,
#           file = "output/ecosystem_counts.csv",
#           row.names = FALSE)
```


#4. platform_counts

```{r}
platform_counts <- data %>%
  separate_rows(platform, sep = ",") %>%
  mutate(platform = str_trim(platform)) %>%
  filter(platform != "not reported") %>%    # remove 'not reported'
  distinct(study_ID, platform) %>%
  count(platform, name = "n_studies") %>%
  arrange(desc(n_studies))

# write.csv(platform_counts,
#           file = "output/platform_counts.csv",
#           row.names = FALSE)
```


#5. sensor_counts

```{r}
sensor_counts <- data %>%
  separate_rows(sensor, sep = ",") %>%
  mutate(sensor = str_trim(sensor)) %>%
  filter(sensor != "not reported") %>% # remove not reported
  distinct(study_ID, sensor) %>%
  count(sensor, name = "n_studies") %>%
  arrange(desc(n_studies))

# write.csv(sensor_counts,
#           file = "output/sensor_counts.csv",
#           row.names = FALSE)
```


#6. topic_counts

```{r}
topic_counts <- data %>%
  separate_rows(topic, sep = ",") %>%
  mutate(topic = str_trim(topic)) %>%
  filter(topic != "") %>%
  distinct(study_ID, topic) %>%
  count(topic, name = "n_studies") %>%
  arrange(desc(n_studies))

# fix misspellings
topic_counts <- topic_counts %>%
  mutate(topic = case_when(
    topic %in% c("Plant physiological performance", 
                 "Plany physiological performance") ~ 
      "Plant physiological performance",
    topic %in% c("Carbon/nutrient fluxes", 
                 "Carbon and nutrient fluxes") ~ 
      "Carbon/nutrient fluxes",
    TRUE ~ topic
  )) %>%
  group_by(topic) %>%
  summarise(n_studies = sum(n_studies), .groups = "drop") %>%
  arrange(desc(n_studies))

# write.csv(topic_counts,
#           file = "output/topic_counts.csv",
#           row.names = FALSE)
```


#7. spatial resolution distribution

spatial resolution data was not provided for many studies - remove these
```{r}
spatial_data <- data %>%
  filter(!is.na(spatial_resolution),
         spatial_resolution != "")
```

this is a critical step
- separates rows with multiple sensors, resolutions by columns
  maintaining the order of each, which is extremely important
```{r}
spatial_data <- spatial_data %>%
  mutate(
    sensor = str_split(sensor, ","),
    spatial_resolution = str_split(spatial_resolution, ",")
  ) %>%
  mutate(
    paired = map2(sensor, spatial_resolution, \(s, r) {
      s <- str_trim(s)
      r <- str_trim(r)

      n <- max(length(s), length(r))
      s <- c(s, rep(NA, n - length(s)))
      r <- c(r, rep(NA, n - length(r)))

      tibble(sensor = s, spatial_resolution = r)
    })
  ) %>%
  select(-sensor, -spatial_resolution) %>%
  unnest(paired)
```

remove straggler NAs, empty values
```{r}
spatial_data <- spatial_data %>%
  filter(
    !is.na(spatial_resolution),
    spatial_resolution != "",
    str_to_upper(str_trim(spatial_resolution)) != "NA"
  )
```

split spatial_resolution again, make a units column
```{r}
spatial_data <- spatial_data %>%
  separate(
    spatial_resolution,
    into = c("spatial_resolution", "resolution_units"),
    sep = "\\s+",
    extra = "merge",
    fill = "right"
  )
```

some LiDAR studies report resolution in pixels, others in raw data
- for now remove ppm (points per meter), this comes from raw LiDAR clouds
- make two separate dfs with and without ppm
```{r}
spatial_data_no_ppm <- spatial_data %>%
  filter(!str_to_lower(resolution_units) %in% "ppm")

# and here making a separate df just with ppm
spatial_data_ppm <- spatial_data %>%
  filter(str_to_lower(resolution_units) == "ppm")
```

histogram colored and stacked by sensor type
```{r}
# make numeric, capitalize sensor column for histogram
spatial_data_no_ppm <- spatial_data_no_ppm %>%
  mutate(spatial_resolution = as.numeric(spatial_resolution)) %>%
  rename(Sensor = sensor)
  
spatial_hist <- ggplot(spatial_data_no_ppm, 
                       aes(x = spatial_resolution, fill = Sensor)) +
  geom_histogram(position = "stack", alpha = 0.7, bins = 30) +
  scale_x_log10() +
  labs(
    x = "Spatial resolution in meters (log scale)",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14),
    legend.title = element_text(size = 16),
    legend.text  = element_text(size = 14)
  ) +
  scale_fill_brewer(palette = "Set2")

# increase space between title and axes
spatial_hist <- spatial_hist +
  theme(
    axis.title.x = element_text(
      size = 16,
      margin = margin(t = 18)   # space above x title
    ),
    axis.title.y = element_text(
      size = 16,
      margin = margin(r = 18)   # space to right of y title
    ),
    axis.text = element_text(size = 14)
  )

spatial_hist

# ggsave(
#   filename = "output/spatial_resolution_histogram.png",  
#   plot = spatial_hist, width = 8, height = 6, units = "in", dpi = 300)
```

also make histogram for studies reporting raw LiDAR ppm resolution
```{r}
# make numeric
spatial_data_ppm <- spatial_data_ppm %>%
  mutate(spatial_resolution = as.numeric(spatial_resolution))

spatial_hist_ppm <- ggplot(spatial_data_ppm, 
                           aes(x = spatial_resolution)) +
  geom_histogram(
    position = "stack",
    alpha = 0.7,
    bins = 30,
    fill = "#8DA0CB"
  ) +
  labs(
    x = "LiDAR spatial resolution in points per meter",
    y = "Count"
  ) +
  theme_minimal() +
    theme(
    axis.title = element_text(size = 16),
    axis.text  = element_text(size = 14)
  )

# increase space between title and axes
spatial_hist_ppm <- spatial_hist_ppm +
  theme(
    axis.title.x = element_text(
      size = 16,
      margin = margin(t = 18)   # space above x title
    ),
    axis.title.y = element_text(
      size = 16,
      margin = margin(r = 18)   # space to right of y title
    ),
    axis.text = element_text(size = 14)
  )

spatial_hist_ppm

ggsave(
  filename = "output/spatial_resolution_histogram_ppm.png",
  plot = spatial_hist, width = 8, height = 6, units = "in", dpi = 300)
```



#8. spatial extent distribution



